<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LEGO Dimensions – Characters & Abilities</title>
  <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b1020">

  <style>
    :root {
      --bg: #0b1020;
      --panel: #151b2e;
      --muted: #8ea0bf;
      --text: #e6eeff;
      --accent: #5cc8ff;
      --chip: #223153;
      --chip2: #2b3a61;
      --badge: #2a3f6e;
      --badgeBorder: #3b5592;
      --border-header: #243254;
      --border-input: #263657;
      --border-chip: #32466f;
      --border-button: #2a3c63;
      --border-image: #1c2744;
      --border-ability: #334973;
      --bg-gradient-end: #0e1426;
      --card-gradient-start: #131a2c;
      --card-gradient-end: #10172a;
      --bg-image: #0e1530;
      --bg-button: #1a2544;
      --bg-pill: #0f1a34;
      --text-button: #d7e6ff;
      --text-ability: #cfe2ff;
      --text-count: #b7d9ff;
      --text-link: #9bd6ff;
      --owned-border: limegreen;
      --owned-glow: rgba(50, 205, 50, 0.6);
      --focus-shadow: rgba(92, 200, 255, 0.15);
    }

    *{box-sizing:border-box}
    html,body{margin:0;height:100%}
    body{font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial; background:linear-gradient(180deg,#0b1020,#0e1426 200px); color:var(--text)}
    header{position:static;top:0;z-index:5;background:linear-gradient(180deg,rgba(11,16,32,.95),rgba(11,16,32,.85));backdrop-filter:saturate(140%) blur(10px);border-bottom:1px solid #243254}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    h1{font-size:clamp(20px,3vw,28px);margin:0 0 8px 0}
    .sub{color:var(--muted);font-size:14px;margin:0}
    .controls{display:grid;gap:12px;grid-template-columns:1fr;grid-template-areas:"search" "toolbar" "chips" "filters";align-items:start;margin-top:12px}
    .search-block{grid-area:search}
    .toolbar{grid-area:toolbar;display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-top:8px}
    #activeChips{grid-area:chips}
    .filters-row{grid-area:filters}
    @media(min-width:980px){.controls{grid-template-columns:minmax(420px,560px) 1fr;grid-template-areas:"search filters" "toolbar toolbar" "chips chips"}}

    /* --- NIEUWE CODE VOOR DESKTOP --- */
    @media (min-width: 980px) {
      body {
        height: auto;
      }
      header {
        position: sticky;
      }
    }
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select{width:100%;background:var(--panel);border:1px solid #263657;color:var(--text);padding:10px 12px;border-radius:12px;outline:none;min-width:0}
    input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(92,200,255,.15)}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .chip{background:var(--chip);border:1px solid #32466f;color:var(--text);padding:6px 10px;border-radius:999px;font-size:12px;display:inline-flex;align-items:center;gap:8px}
    .chip button{all:unset;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;font-weight:700;line-height:1;background:#2b3a61}
    .chip button:focus{outline:2px solid var(--accent)}
    .pill{background:#0f1a34;border:1px solid #2a3c63;color:var(--muted);padding:6px 10px;border-radius:999px;font-size:12px}
    #q{max-width:560px}
    .row{display:grid;gap:10px;grid-template-columns:repeat(3,minmax(0,1fr))}
    @media(min-width:700px){.row{grid-template-columns:repeat(3,minmax(0,1fr))}}
    @media(min-width:980px){.row{grid-template-columns:repeat(5,minmax(180px,1fr))}}
    .grid{display:grid;gap:14px;margin:18px 0 40px}
    @media(min-width:700px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:1050px){.grid{grid-template-columns:repeat(3,1fr)}}
    .card{background:linear-gradient(180deg,#131a2c,#10172a);border:1px solid #223153;border-radius:16px;overflow:hidden;display:flex;gap:12px;padding:12px;position:relative}
    .card img{width:110px;height:110px;object-fit:contain;background:radial-gradient(120px 120px at 50% 50%,#0e1530,#0b1020);border-radius:12px;border:1px solid #1c2744}
    .card-body{flex:1;min-width:0}
    .title{display:flex;align-items:center;gap:8px}
    .title h3{font-size:18px;line-height:1.2;margin:0}
    .meta{color:var(--muted);font-size:12px}
    .abilities{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px}
    .ability{background:var(--chip2);border:1px solid #334973;color:#cfe2ff;padding:4px 8px;border-radius:999px;font-size:12px}
    .pack{display:flex;flex-wrap:wrap;gap:8px 10px;align-items:center;margin-top:10px;line-height:1.35;font-size:13px}
    .pack .pill{flex:0 0 auto}
    .pack .pack-name{font-weight:700;overflow-wrap:anywhere;color:#cfe2ff}
    .pack .pack-extra{color:var(--muted);flex:0 0 auto}
    .count{font-weight:600;color:#b7d9ff}
    .btn{background:#1a2544;border:1px solid #2a3c63;color:#d7e6ff;padding:8px 12px;border-radius:12px;font-weight:600;cursor:pointer}
    
    /* --- HIER IS DE WIJZIGING --- */
    .btn[aria-pressed="true"] {
      background: transparent;
      border: 2px solid var(--accent);
      color: var(--accent);
      padding: 7px 11px;
    }

    .ghost{background:transparent}
    footer{border-top:1px solid #243254}
    a{color:#9bd6ff}
    .group-title{grid-column:1/-1;margin:24px 6px 8px;font-size:18px;color:var(--muted);font-weight:700;display:flex;align-items:center}
    .owned-checkbox{position:absolute;top:8px;right:8px;width:20px;height:20px;cursor:pointer}
    .card.owned{border:2px solid limegreen;box-shadow:0 0 10px rgba(50,205,50,.6)}
    .toggle-wrap{display:flex;align-items:center;gap:6px;background:#1a2544;padding:0 12px;height:36px;border-radius:12px;font-size:14px;border:1px solid #2a3c63}
    .red-brick-placeholder {
      display: inline-block;
      width: 18px;
      height: 18px;
      background-image: url('./backgroundremoved/redbrickicon.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      border-radius: 4px;
      margin-left: 10px;
      position: relative;
      cursor: pointer;
    }
    .red-brick-placeholder::after {
      content: attr(data-tooltip);
      position: absolute;
      z-index: 10;
      background: var(--chip);
      color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: opacity .2s, visibility .2s;
  
  /* Aangepaste regels voor positionering */
      top: 50%;
      left: 100%;
      transform: translateY(-50%);
      margin-left: 8px; 
    }
    .red-brick-placeholder:hover::after{opacity:1;visibility:visible}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>LEGO Dimensions – Characters & Abilities</h1>
      <p class="sub">Filter by ability, franchise, pack type, year or wave. Search by name or franchise.</p>

      <div class="controls">
        <div class="search-block">
          <label for="q">Search</label>
          <input id="q" name="q" type="search" placeholder="e.g. Batman, Ghostbusters, Portal…" autocomplete="off" />
        </div>

        <div class="filters-row">
          <div class="row">
            <div><label for="franchise">Franchise</label><select id="franchise"><option value="">All</option></select></div>
            <div><label for="type">Pack type</label><select id="type"><option value="">All</option><option>Starter</option><option>Story</option><option>Level</option><option>Team</option><option>Fun</option><option>Polybag</option></select></div>
            <div><label for="year">Release year</label><select id="year"><option value="">All</option></select></div>
            <div><label for="wave">Release wave</label><select id="wave"><option value="">All</option></select></div>
            <div><label for="ability">Add ability</label><select id="ability"><option value="">(Select an ability)</option></select></div>
          </div>
        </div>

        <div class="toolbar" aria-label="tools">
          <button id="clearFilters" class="btn ghost" type="button">Reset filters</button>
          <span class="pill" id="count">0 results</span>
          <button id="groupPack" class="btn" type="button" aria-pressed="false" title="Group by pack">Group by pack</button>
          <button id="groupFranchise" class="btn" type="button" aria-pressed="false" title="Group by franchise">Group by franchise</button>
          <button id="hideSideCharsBtn" class="btn" type="button" aria-pressed="false" title="Hide side characters">Hide side characters</button>
        </div>

        <div class="chips" id="activeChips" aria-live="polite"></div>
      </div>
    </div>
  </header>

  <main class="container">
    <section id="grid" class="grid" aria-live="polite"></section>
  </main>

  <footer class="container" style="padding:22px 16px 40px">
    <small class="sub">Kuilvoer</small>
  </footer>

  <template id="cardTemplate">
    <article class="card" tabindex="0">
      <input type="checkbox" class="owned-checkbox" title="Mark as owned" />
      <img alt="minifig" loading="lazy"/>
      <div class="card-body">
        <div class="title">
          <h3 class="name"></h3>
        </div>
        <div class="meta franchise"></div>
        <div class="abilities" aria-label="Abilities"></div>
        <div class="pack"></div>
      </div>
    </article>
  </template>

  <script>
    const $ = (q, el=document) => el.querySelector(q);
    const state = {
      data: [],
      // Nieuw: een plek om de Red Brick data op te slaan
      redBricks: {}, 
      filters: { q:'', franchise:'', type:'', year:'', wave:'', abilities:[] },
      groupByPack: false,
      groupByFranchise: false,
      hideSideChars: false
    };

    async function load(){
      try {
        const res = await fetch('./characters.json',{cache:'no-store'});
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const json = await res.json();
        
        // WIJZIGING: We lezen nu de 'characters' én 'redBricks' uit het JSON-bestand
        state.data = json.characters || [];
        state.redBricks = json.redBricks || {};

        normalize(state.data);
        buildFilterOptions(state.data);
        render();
      } catch (e) {
        console.error("Failed to load characters.json:", e);
        const grid = $('#grid');
        grid.innerHTML = `<div class="card" style="background: var(--panel); border-color: #e53935;"><div class="card-body"><h3>Error loading data</h3><p class="meta">Could not fetch characters.json. Please ensure the file is in the same directory and there are no network issues.</p><p class="meta">Details: ${e.message}</p></div></div>`;
      }
    }

    function normalize(list){
      for(const c of list){
        if(!Array.isArray(c.abilities)) c.abilities=[];
        c.pack = c.pack||{};
        c._wave = c.pack.releaseWave ?? null;
        c._year = c.gameYear || c.pack.releaseYear || null;
        c._yearLabel = c._year ? `Year ${c._year}` : 'Year ?';
      }
    }

    function uniqueSorted(list){ return [...new Set(list)].filter(Boolean).sort((a,b)=>String(a).localeCompare(String(b),'en')); }

    function buildFilterOptions(list){
      const franchises = uniqueSorted(list.map(c=>c.franchise));
      const abilities  = uniqueSorted(list.flatMap(c=>c.abilities||[]));
      const waves      = uniqueSorted(list.map(c=>c._wave).filter(v=>v!=null));
      const years      = uniqueSorted(list.map(c=>c._yearLabel));

      const $fr=$('#franchise'); franchises.forEach(f=>{const o=document.createElement('option');o.value=f;o.textContent=f;$fr.appendChild(o);});
      const $ab=$('#ability'); abilities.forEach(a=>{const o=document.createElement('option');o.value=a;o.textContent=a;$ab.appendChild(o);});
      const $yr=$('#year'); years.forEach(y=>{const o=document.createElement('option');o.value=y;o.textContent=y;$yr.appendChild(o);});
      const $wv=$('#wave'); waves.forEach(w=>{const o=document.createElement('option');o.value=String(w);o.textContent=`Wave ${w}`;$wv.appendChild(o);});
    }

    function filterData(){
      const {q,franchise,type,year,wave,abilities}=state.filters;
      const ql=q.trim().toLowerCase();
      return state.data.filter(c=>{
        if (state.hideSideChars && c.characterType === 'side') return false;
        const matchesQ=!ql||(c.name?.toLowerCase().includes(ql)||c.franchise?.toLowerCase().includes(ql));
        const matchesF=!franchise||c.franchise===franchise;
        const matchesT=!type||c.pack?.type===type;
        const matchesY=!year||c._yearLabel===year;
        const matchesW=!wave||String(c._wave)===String(wave);
        const matchesA=!abilities.length||abilities.every(a=>(c.abilities||[]).includes(a));
        return matchesQ&&matchesF&&matchesT&&matchesY&&matchesW&&matchesA;
      });
    }

    function sortByNameAsc(items){
      const collator = new Intl.Collator('en', {sensitivity:'base'});
      return items.sort((a,b)=>collator.compare(a.name||'', b.name||''));
    }

    function groupBy(items, keyFn){ return items.reduce((acc,item)=>{const k=keyFn(item);(acc[k]||(acc[k]=[])).push(item);return acc;},{}); }

    function waveText(c){ return (c._wave!=null) ? `Wave ${c._wave}` : 'Wave ?'; }

    function render(){
      const grid=$('#grid');
      let items=filterData();
      items = sortByNameAsc(items); 

      $('#count').textContent=`${items.length} result${items.length===1?'':'s'}`;
      grid.innerHTML='';
      $('#groupPack').setAttribute('aria-pressed', String(state.groupByPack));
      $('#groupFranchise').setAttribute('aria-pressed', String(state.groupByFranchise));
      $('#hideSideCharsBtn').setAttribute('aria-pressed', String(state.hideSideChars));

      renderChips();

      if (state.groupByPack) {
        const grouped = groupBy(items, c => `${c._year}|${c._wave}|${c.pack?.name}|${c.pack?.type}`);
        
        const groups = Object.entries(grouped).sort((a, b) => {
          const packA = a[1][0];
          const packB = b[1][0];
          if (packA._year !== packB._year) return (packA._year || 99) - (packB._year || 99);
          if (packA._wave !== packB._wave) return (packA._wave || 99) - (packB._wave || 99);
          if (b[1].length !== a[1].length) return b[1].length - a[1].length;
          return (packA.pack.name || '').localeCompare(packB.pack.name || '', 'en');
        });

        for (const [key, list] of groups) {
          const c = list[0];
          const title = `${c.pack?.type || 'Pack'} — ${c.pack?.name || 'Unknown'}`;
          const h = document.createElement('h2');
          h.className = 'group-title';
          h.textContent = title;
          grid.appendChild(h);
          list.forEach(item => grid.appendChild(card(item)));
        }

      } else if (state.groupByFranchise) {
        const grouped=groupBy(items,c=>c.franchise||'Unknown');
        const groups=Object.entries(grouped).sort((a,b)=>a[0].localeCompare(b[0],'en'));
        for(const [title,list] of groups){
          const h=document.createElement('h2');
          h.className='group-title';
          
          // --- GROTE WIJZIGING HIER ---
          // De oude code had hier een vaste tekst.
          // Deze nieuwe code zoekt de Red Brick op en bouwt de tooltip dynamisch op.
          const redBrick = state.redBricks[title];
          let titleHtml = title; // De titel van de franchise
          
          if (redBrick) {
            // Bouw de tooltip-tekst op
            let tooltipText = `Red Brick: ${redBrick.name} -`;
            tooltipText += `\n\n${redBrick.description}`;
            
            // Voeg de placeholder met de gevulde data-tooltip toe aan de titel
            titleHtml += ` <span class="red-brick-placeholder" data-tooltip="${tooltipText}"></span>`;
          }
          
          h.innerHTML = titleHtml;
          // --- EINDE WIJZIGING ---

          grid.appendChild(h);
          list.forEach(c=>grid.appendChild(card(c)));
        }
      } else {
        items.forEach(c=>grid.appendChild(card(c)));
      }

      if(!items.length){
        const div=document.createElement('div');
        div.className='card';
        div.innerHTML=`<div class="card-body"><h3>No results</h3><p class="meta">Try fewer filters or another search term.</p></div>`;
        grid.appendChild(div);
      }
    }

    function renderChips(){
      const wrap = $('#activeChips');
      wrap.innerHTML = '';
      const { q, franchise, type, year, wave, abilities } = state.filters;

      const addChip = (label, onRemove) => {
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.innerHTML = `<span>${label}</span>`;
        const btn = document.createElement('button');
        btn.type='button';
        btn.textContent='×';
        btn.setAttribute('aria-label', `Remove ${label} filter`);
        btn.addEventListener('click', onRemove);
        chip.appendChild(btn);
        wrap.appendChild(chip);
      };

      if(q){ addChip(`Search: “${q}”`, ()=>{ state.filters.q=''; $('#q').value=''; render(); }); }
      if(franchise){ addChip(`Franchise: ${franchise}`, ()=>{ state.filters.franchise=''; $('#franchise').value=''; render(); }); }
      if(type){ addChip(`Type: ${type}`, ()=>{ state.filters.type=''; $('#type').value=''; render(); }); }
      if(year){ addChip(`Year: ${year}`, ()=>{ state.filters.year=''; $('#year').value=''; render(); }); }
      if(wave){ addChip(`Wave: ${wave}`, ()=>{ state.filters.wave=''; $('#wave').value=''; render(); }); }
      (abilities||[]).forEach(a=>{ addChip(`Ability: ${a}`, ()=>{ state.filters.abilities=state.filters.abilities.filter(x=>x!==a); render(); }); });

      if(!wrap.childElementCount){ const hint=document.createElement('span'); hint.className='pill'; hint.textContent='No active filters'; wrap.appendChild(hint); }
    }

    function card(c){
      const tpl=$('#cardTemplate');
      const el=tpl.content.firstElementChild.cloneNode(true);
      $('.owned-checkbox', el).addEventListener('change', (e)=>{ el.classList.toggle('owned', e.target.checked); });

      const img = $('img',el); 
      const hasImg = c.minifigure?.imageUrl && !c.minifigure.imageUrl.includes('unknown');
      if (hasImg) {
        img.src = c.minifigure.imageUrl;
      } else {
        img.style.display = 'none';
        const placeholder = document.createElement('div');
        placeholder.style.width = '110px';
        placeholder.style.height = '110px';
        img.parentElement.insertBefore(placeholder, img);
      }
      img.alt = `${c.name} – minifig`;
      
      $('.name',el).textContent=c.name;
      $('.franchise', el).textContent = c.franchise || '';

      const ab=$('.abilities',el);
      (c.abilities||[]).forEach(a=>{
        const s=document.createElement('span'); s.className='ability'; s.textContent=a; ab.appendChild(s);
      });

      const p = $('.pack', el);
      p.innerHTML = [
        `<span class="pill">${c.pack?.type || 'Pack'}</span>`,
        `<b class="pack-name">${c.pack?.name || 'Unknown'}</b>`,
        `<span class="pack-extra">• ${c._yearLabel} • ${waveText(c)}</span>`
      ].join(' ');
      return el;
    }

    function setupEventListeners() {
      $('#q').addEventListener('input',e=>{state.filters.q=e.target.value;render();});
      $('#franchise').addEventListener('change',e=>{state.filters.franchise=e.target.value;render();});
      $('#type').addEventListener('change',e=>{state.filters.type=e.target.value;render();});
      $('#year').addEventListener('change',e=>{state.filters.year=e.target.value;render();});
      $('#wave').addEventListener('change',e=>{state.filters.wave=e.target.value;render();});
      $('#ability').addEventListener('change',e=>{
        const v=e.target.value;
        if(!v) return;
        if(!state.filters.abilities.includes(v)) state.filters.abilities.push(v);
        e.target.value='';
        render();
      });
      $('#clearFilters').addEventListener('click',()=>{
        state.filters={q:'',franchise:'',type:'',year:'',wave:'',abilities:[]};
        $('#q').value='';$('#franchise').value='';$('#type').value='';$('#year').value='';$('#wave').value='';
        render();
      });
      $('#groupPack').addEventListener('click',e=>{
        state.groupByPack=!state.groupByPack;
        state.groupByFranchise=false;
        render();
      });
      $('#groupFranchise').addEventListener('click',e=>{
        state.groupByFranchise=!state.groupByFranchise;
        state.groupByPack=false;
        render();
      });
      $('#hideSideCharsBtn').addEventListener('click', e => {
        state.hideSideChars = !state.hideSideChars;
        render();
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      setupEventListeners();
      load();
    });
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then(reg => console.log('Service Worker registered:', reg.scope))
          .catch(err => console.error('SW registration failed:', err));
      });
    }
  </script>

  <script src="selection.js"></script>
</body>
</html>